---
menuIcon: ğŸ“¦
title: "**Blockchain - åŒºå—é“¾**"
entries:
- struct
- message_pool
- chainsync
- storage_power_consensus
---

{{< incTocMap "/docs/systems/filecoin_blockchain" 3 >}}


The Filecoin Blockchain is a distributed virtual machine that achieves consensus, processes messages, accounts for storage, and maintains security in the Filecoin Protocol.

FilecoinåŒºå—é“¾æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è™šæ‹Ÿæœºï¼Œå®ƒåœ¨Filecoinåè®®ä¸­å®ç°å…±è¯†ã€å¤„ç†æ¶ˆæ¯ã€å­˜å‚¨å¸æˆ·å’Œç»´æŠ¤å®‰å…¨æ€§

It includes:

å®ƒåŒ…æ‹¬ï¼š

- A {{<sref message_pool>}} subsystem that nodes use to track and propagate messages related to the storage market throughout a gossip network.
- ä¸€ä¸ª{{<sref message_pool "æ¶ˆæ¯æ± ">}}å­ç³»ç»Ÿ, å®ƒåœ¨æ•´ä¸ªé—²èŠç½‘ç»œèŠ‚ç‚¹ä¸­ç”¨æ¥è·Ÿè¸ªå’Œä¼ æ’­ä¸å­˜å‚¨å¸‚åœºç›¸å…³çš„æ¶ˆæ¯ã€‚
- A {{<sref chainsync>}} susbystem that tracks and propagates validated message blocks, assembling them into subchains corresponding to versions of the system state.
- ä¸€ä¸ª{{<sref chainsync "é“¾åŒæ­¥">}} å­ç³»ç»Ÿï¼Œå®ƒè·Ÿè¸ªå’Œä¼ æ’­ç»è¿‡éªŒè¯çš„æ¶ˆæ¯å—ï¼Œå°†å®ƒä»¬ç»„è£…æˆä¸ç³»ç»ŸçŠ¶æ€çš„ç‰ˆæœ¬å¯¹åº”çš„å­é“¾ã€‚
- A {{<sref vm>}} subsystem used to interpret and execute messages in order to update system state.
- ä¸€ä¸ª{{<sref vm "è™šæ‹Ÿæœº">}}å­ç³»ç»Ÿç”¨äºè§£é‡Šå’Œæ‰§è¡Œæ¶ˆæ¯ä»¥æ›´æ–°ç³»ç»ŸçŠ¶æ€
- A {{<sref state_tree>}} subsystem which manages the creation and maintenance of state trees (the system state) deterministically generated by the vm from a given subchain.
- ä¸€ä¸ª{{<sref state_tree "çŠ¶æ€æƒ">}}å­ç³»ç»Ÿç”¨äºç®¡ç†çŠ¶æ€æ ‘(ç³»ç»ŸçŠ¶æ€)çš„åˆ›å»ºå’Œç»´æŠ¤ï¼Œç”±vmä»ç»™å®šçš„å­é“¾ç¡®å®šåœ°ç”Ÿæˆ
- A {{<sref storage_power_consensus>}} subsystem which tracks {{<sref storage_mining_subsystem "storage">}} state for a given chain and helps the blockchain system choose subchains to extend and blocks to include in them.
- ä¸€ä¸ª{{<sref storage_power_consensus "å­˜å‚¨æƒé‡å…±è¯†">}}å­ç³»ç»Ÿï¼Œå®ƒè·Ÿè¸ªç»™å®šé“¾çš„å­˜å‚¨çŠ¶æ€ï¼Œå¹¶å¸®åŠ©åŒºå—é“¾ç³»ç»Ÿé€‰æ‹©è¦æ‰©å±•çš„å­é“¾å’Œè¦åŒ…å«åœ¨å…¶ä¸­çš„å—ã€‚

At a high-level, the Filecoin blockchain grows through successive rounds of leader election in which a number of miners are elected to generate a block, whose inclusion in the chain will earn them block rewards.

åœ¨ä¸€ä¸ªé«˜çš„çº§åˆ«ï¼ŒFilecoinåŒºå—é“¾é€šè¿‡è¿ç»­å‡ è½®çš„é¢†å¯¼äººé€‰ä¸¾æ¥å¢é•¿ï¼Œåœ¨è¿™è½®é€‰ä¸¾ä¸­ï¼Œä¸€äº›çŸ¿å·¥è¢«é€‰å‡ºæ¥äº§ç”Ÿä¸€ä¸ªåŒºå—ï¼Œå…¶åŒ…å«åœ¨é“¾ä¸­å°†ä¸ºä»–ä»¬èµ¢å¾—åŒºå—å¥–åŠ±ã€‚

Most of the functions of the Filecoin blockchain system are detailed in the code below. We focus here on particular points of interest.

ä¸‹é¢çš„ä»£ç è¯¦ç»†ä»‹ç»äº†FilecoinåŒºå—é“¾ç³»ç»Ÿçš„å¤§éƒ¨åˆ†åŠŸèƒ½ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œé›†ä¸­è®¨è®ºä¸€äº›ç‰¹æ®Šçš„å…´è¶£ç‚¹ã€‚

## Storage Power - å­˜å‚¨æƒé‡

Filecoin's blockchain runs on storage power. That is, its consensus algorithm by which miners agree on which subchain to mine is predicated on the amount of storage backing that subchain. At a high-level, the {{<sref storage_power_consensus>}} subsystem maintains a _Power Table_ that tracks the amount of storage {{<sref storage_mining_subsystem "storage miner actors">}} have contributed to the network through _Sector commitments_ and _Proofs of Spacetime_.

Filecoinçš„åŒºå—é“¾è¿è¡Œåœ¨å­˜å‚¨æƒé‡ä¸Šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒçš„ä¸€è‡´ç®—æ³•æ˜¯æ ¹æ®æ”¯æŒè¯¥å­é“¾çš„å­˜å‚¨é‡æ¥é¢„æµ‹å“ªä¸ªå­é“¾é€‚åˆäºæŒ–çŸ¿ã€‚åœ¨é«˜çº§åˆ«æ¬¡ä¸Šï¼Œ{{<sref storage_power_consensus "å­˜å‚¨æƒé‡å…±è¯†">}}å­ç³»ç»Ÿç»´æŠ¤ä¸€ä¸ª _æƒé‡è¡¨_ ï¼Œé€šè¿‡{{<sref storage_mining_subsystem "å­˜å‚¨çŸ¿å·¥è§’è‰²">}}æ¥è·Ÿè¸ª _æ‰‡åŒºæ‰¿è¯º_ å’Œ _æ—¶ç©ºè¯æ˜_ å‘ç½‘ç»œè´¡çŒ®çš„å­˜å‚¨é‡ã€‚

## Leader Election and Expected Consensus - é¢†å¯¼äººé€‰ä¸¾ä¸é¢„æœŸå…±è¯†

The leader election process is likewise handled by the {{<sref storage_power_consensus>}} subsystem (SPC). Using the _Power Table_ it maintains, this subsystem runs a Nakamoto-style leader election process called Expected Consensus at every round to elect miners who can extend the block chain by generating new blocks.

é¢†å¯¼äººé€‰ä¸¾è¿‡ç¨‹åŒæ ·ç”±{{<sref storage_power_consensus "å­˜å‚¨æƒé‡å…±è¯†">}} å­ç³»ç»Ÿ(SPC)å¤„ç†ã€‚ä½¿ç”¨å®ƒç»´æŠ¤çš„ _æƒé‡è¡¨_ ï¼Œè¿™ä¸ªå­ç³»ç»Ÿè¿è¡Œä¸€ä¸ªNakamtoé£æ ¼çš„é¢†å¯¼äººé€‰ä¸¾è¿‡ç¨‹ï¼Œç§°ä¸ºé¢„æœŸå…±è¯†ï¼Œåœ¨æ¯ä¸€è½®é€‰ä¸¾ä¸­é€‰å‡ºå¯ä»¥é€šè¿‡ç”Ÿæˆæ–°åŒºå—æ¥æ‰©å±•åŒºå—é“¾çš„çŸ¿å·¥ã€‚

Beyond participating in the Storage Market (see the {{<sref storage_market>}} spec), participation in Filecoin's consensus is the other way storage miners can earn Filecoin tokens.

é™¤äº†å‚ä¸å­˜å‚¨å¸‚åœº(å‚è€ƒ{{<sref storage_market "å­˜å‚¨å¸‚åœº">}}è§„èŒƒ)ä¹‹å¤–ï¼Œå‚ä¸Filecoinçš„å…±è¯†æ˜¯å­˜å‚¨çŸ¿å·¥è·å¾—Filecoinä»¤ç‰Œçš„å¦ä¸€ç§æ–¹å¼ã€‚

{{<sref expected_consensus>}} has two main components: a leader election process and a chain selection algorithm dependent on a weight function.
{{<sref expected_consensus "æ‰©å±•å…±è¯†">}} æœ‰ä¸¤ä¸ªä¸»è¦ç»„ä»¶:ä¸€ä¸ªé¢†å¯¼äººé€‰ä¸¾è¿‡ç¨‹å’Œä¸€ä¸ªåŸºäºæƒé‡å‡½æ•°çš„é“¾é€‰æ‹©ç®—æ³•ã€‚

## Tipsets - æç¤ºè®¾ç½®

EC can elect multiple leaders in a given round meaning Filecoin chains can contain multiple blocks at each height (one per winning miner). This greatly increases chain throughput by allowing blocks to propagate through the network of nodes more efficiently but also means miners should coordinate how they select messages for inclusion in their blocks in order to avoid duplicates and maximize their earnings from transaction fees (see {{<sref message_pool>}}).

ECå¯ä»¥åœ¨ç»™å®šçš„å›åˆä¸­é€‰æ‹©å¤šä¸ªé¢†å¯¼äººï¼Œè¿™æ„å‘³ç€Filecoiné“¾å¯ä»¥åœ¨æ¯ä¸ªé«˜åº¦åŒ…å«å¤šä¸ªå—(æ¯ä¸ªè·èƒœçš„çŸ¿å·¥ä¸€ä¸ªå—)ã€‚è¿™æå¤§åœ°æé«˜äº†é“¾ååé‡ï¼Œå…è®¸å—æ›´æœ‰æ•ˆåœ°åœ¨èŠ‚ç‚¹ç½‘ç»œä¸­ä¼ æ’­ï¼Œä½†ä¹Ÿæ„å‘³ç€çŸ¿å•†åº”è¯¥åè°ƒå¦‚ä½•é€‰æ‹©è¦åŒ…å«åœ¨ä»–ä»¬çš„å—ä¸­çš„æ¶ˆæ¯ï¼Œä»¥é¿å…é‡å¤å’Œæœ€å¤§åŒ–ä»–ä»¬çš„äº¤æ˜“è´¹ç”¨æ”¶å…¥(å‚è§{{<sref message_pool "æ¶ˆæ¯æ± ">}})ã€‚

Accordingly, blocks from a given round are assembled into Tipsets according to certain rules (they must share the same parents and have been mined at the same height). The Filecoin state tree is modified by the execution of all messages in a given Tipset. Different miners may mine on different Tipsets because of network propagation delay.

å› æ­¤ï¼Œæ ¹æ®ç‰¹å®šçš„è§„åˆ™(å®ƒä»¬å¿…é¡»å…±äº«ç›¸åŒçš„çˆ¶å…ƒç´ ï¼Œå¹¶ä¸”åœ¨ç›¸åŒçš„é«˜åº¦è¢«å¼€é‡‡)ï¼Œå°†æ¥è‡ªç»™å®šå›åˆçš„å—ç»„è£…åˆ°tipsetä¸­ã€‚é€šè¿‡æ‰§è¡Œç»™å®šTipsetä¸­çš„æ‰€æœ‰æ¶ˆæ¯æ¥ä¿®æ”¹FilecoinçŠ¶æ€æ ‘ã€‚ç”±äºç½‘ç»œä¼ æ’­å»¶è¿Ÿçš„åŸå› ï¼Œä¸åŒçš„é‡‡çŸ¿è€…å¯èƒ½åœ¨ä¸åŒçš„tipsetä¸Šè¿›è¡Œå¼€é‡‡ã€‚

Due to this fact, adding new blocks to the chain actually validate those blocks' parent Tipsets, that is: executing the messages of a new block, a miner cannot know exactly what state tree this will yield. That state tree is only known once all messages in that block's Tipset have been executed. Accordingly, it is in the next round (and based on the number of blocks mined on a given Tipset) that a miner will be able to choose which state tree to extend.

ç”±äºè¿™ä¸ªäº‹å®ï¼Œå‘é“¾ä¸­æ·»åŠ æ–°å—å®é™…ä¸Šä¼šéªŒè¯è¿™äº›å—çš„çˆ¶tipsetï¼Œå³:æ‰§è¡Œæ–°å—çš„æ¶ˆæ¯ï¼ŒçŸ¿å·¥ä¸èƒ½ç¡®åˆ‡åœ°çŸ¥é“è¿™ä¼šäº§ç”Ÿä»€ä¹ˆçŠ¶æ€æ ‘ã€‚è¯¥çŠ¶æ€æ ‘åªæœ‰åœ¨è¯¥å—çš„Tipsetä¸­çš„æ‰€æœ‰æ¶ˆæ¯éƒ½è¢«æ‰§è¡Œä¹‹åæ‰çŸ¥é“ã€‚å› æ­¤ï¼Œåœ¨ä¸‹ä¸€è½®ä¸­(åŸºäºç»™å®šTipsetä¸ŠæŒ–æ˜çš„å—çš„æ•°é‡)ï¼ŒçŸ¿å·¥å°†èƒ½å¤Ÿé€‰æ‹©æ‰©å±•å“ªä¸ªçŠ¶æ€æ ‘ã€‚

## Tipsets

All valid blocks generated in a round form a `Tipset` that participants will attempt to mine off of in the subsequent round (see above). Tipsets are valid so long as:

æ‰€æœ‰æœ‰æ•ˆçš„åŒºå—éƒ½ä»¥â€œTipsetâ€çš„å½¢å¼ç”Ÿæˆï¼Œå‚ä¸è€…å°†åœ¨æ¥ä¸‹æ¥çš„ä¸€è½®ä¸­å°è¯•æŒ–æ˜è¿™äº›åŒºå—(è§ä¸Šæ–‡)ã€‚æç¤ºé›†æ˜¯æœ‰æ•ˆçš„ï¼Œåªè¦ï¼š

- All blocks in a Tipset have the same parent Tipset
- ä¸€ä¸ªTipsetä¸­çš„æ‰€æœ‰å—éƒ½å…·æœ‰ç›¸åŒçš„çˆ¶Tipset
- All blocks in a Tipset have the same number of tickets in their `Tickets` array
- Tipsetä¸­çš„æ‰€æœ‰å—åœ¨å®ƒä»¬çš„`Tickets`æ•°ç»„ä¸­éƒ½æœ‰ç›¸åŒæ•°é‡çš„ç¥¨

These conditions imply that all blocks in a Tipset were mined at the same height. This rule is key to helping ensure that EC converges over time. While multiple new blocks can be mined in a round, subsequent blocks all mine off of a Tipset bringing these blocks together. The second rule means blocks in a Tipset are mined in a same round.

è¿™äº›æ¡ä»¶æ„å‘³ç€ï¼ŒTipsetä¸­çš„æ‰€æœ‰å—éƒ½æ˜¯åœ¨ç›¸åŒçš„é«˜åº¦å¼€é‡‡çš„ã€‚è¿™æ¡è§„åˆ™æ˜¯å¸®åŠ©ç¡®ä¿ECéšç€æ—¶é—´æ”¶æ•›çš„å…³é”®ã€‚è™½ç„¶å¯ä»¥åœ¨ä¸€è½®ä¸­å¼€é‡‡å¤šä¸ªæ–°åŒºå—ï¼Œä½†æ˜¯åç»­çš„åŒºå—éƒ½æ˜¯åœ¨ä¸€ä¸ªTipsetä¸Šå¼€é‡‡çš„ï¼Œå°†è¿™äº›åŒºå—èšé›†åœ¨ä¸€èµ·ã€‚ç¬¬äºŒæ¡è§„åˆ™æ˜¯åœ¨åŒä¸€è½®ä¸­æŒ–æ˜Tipsetä¸­çš„å—ã€‚

The blocks in a tipset have no defined order in representation. During state computation, blocks in a tipset are processed in order of block ticket, breaking ties with the block CID bytes.

tipsetä¸­çš„å—æ²¡æœ‰å®šä¹‰è¡¨ç¤ºé¡ºåºã€‚åœ¨çŠ¶æ€è®¡ç®—æœŸé—´ï¼ŒæŒ‰ç…§å—ç¥¨è¯é¡ºåºå¤„ç†tipsetä¸­çš„å—ï¼Œä»è€Œæ–­å¼€ä¸å—CIDå­—èŠ‚çš„è”ç³»ã€‚

Due to network propagation delay, it is possible for a miner in round N+1 to omit valid blocks mined at round N from their Tipset. This does not make the newly generated block invalid, it does however reduce its weight and chances of being part of the canonical chain in the protocol as defined by EC's {{<sref chain_selection>}} function.

ç”±äºç½‘ç»œä¼ æ’­å»¶è¿Ÿï¼Œåœ¨ç¬¬N+1è½®æŒ–æ˜çš„çŸ¿å•†å¯èƒ½ä¼šä»ä»–ä»¬çš„Tipsetä¸­å¿½ç•¥åœ¨ç¬¬Nè½®æŒ–æ˜çš„æœ‰æ•ˆå—ã€‚è¿™å¹¶ä¸ä¼šä½¿æ–°ç”Ÿæˆçš„å—æ— æ•ˆï¼Œä½†æ˜¯å®ƒç¡®å®é™ä½äº†å®ƒçš„æƒé‡ï¼Œå¹¶ä¸”é™ä½äº†æˆä¸ºåè®®ä¸­è§„èŒƒé“¾çš„ä¸€éƒ¨åˆ†çš„æœºä¼šï¼Œè¿™æ˜¯ç”±ECçš„{{<sref chain_selection "é“¾é€‰æ‹©">}} å‡½æ•°å®šä¹‰çš„ã€‚

## TODO -- reorder this - é‡æ’åºè¿™

The Filecoin blockchain is the main interface linking various actors in the Filecoin system. It ensures that the system's state is verifiably updated over time and dictates how nodes are meant to extend the network through block reception and validation and extend it through block propagation.

FilecoinåŒºå—é“¾æ˜¯è¿æ¥Filecoinç³»ç»Ÿä¸­å„ä¸ªè§’è‰²çš„ä¸»æ¥å£ã€‚å®ƒç¡®ä¿éšç€æ—¶é—´çš„æ¨ç§»ï¼Œç³»ç»Ÿçš„çŠ¶æ€å¾—åˆ°å¯éªŒè¯çš„æ›´æ–°ï¼Œå¹¶æŒ‡ç¤ºèŠ‚ç‚¹å¦‚ä½•é€šè¿‡å—æ¥æ”¶å’ŒéªŒè¯æ‰©å±•ç½‘ç»œï¼Œä»¥åŠå¦‚ä½•é€šè¿‡å—ä¼ æ’­æ‰©å±•ç½‘ç»œã€‚

Its components include the:

å…¶ç»„ä»¶åŒ…æ‹¬:

- {{ <sref chainsync> }} -- which receives and propagates blocks, maintaining sets of candidate chains on which the miner may mine and running syntactic validation on incoming blocks.
- {{ <sref chainsync "é“¾åŒæ­¥"> }} -- å®ƒæ¥æ”¶å’Œä¼ æ’­å—ï¼Œç»´æŠ¤å€™é€‰é“¾é›†ï¼ŒæŒ–æ˜å™¨å¯ä»¥åœ¨è¿™äº›å€™é€‰é“¾é›†ä¸Šè¿›è¡ŒæŒ–æ˜ï¼Œå¹¶åœ¨ä¼ å…¥å—ä¸Šè¿è¡Œè¯­æ³•éªŒè¯ã€‚
- {{ <sref chain_manager> }} -- which maintains a given chain's state, providing facilities to other blockchain subsystems which will query state about the latest chain in order to run, and ensuring incoming blocks are semantically validated before inclusion into the chain.
- {{ <sref chain_manager "é“¾ç®¡ç†å™¨"> }} -- å®ƒç»´æŠ¤ç»™å®šé“¾çš„çŠ¶æ€ï¼Œä¸ºå…¶ä»–åŒºå—é“¾å­ç³»ç»Ÿæä¾›åŠŸèƒ½ï¼Œè¿™äº›å­ç³»ç»Ÿå°†æŸ¥è¯¢å…³äºæœ€æ–°é“¾çš„çŠ¶æ€ä»¥ä¾¿è¿è¡Œï¼Œå¹¶ç¡®ä¿ä¼ å…¥å—åœ¨åŒ…å«åˆ°é“¾ä¹‹å‰ç»è¿‡è¯­ä¹‰éªŒè¯ã€‚
- {{ <sref block_producer> }} -- which is called in the event of a successful leader election in order to produce a new block that will extend the current heaviest chain before forwarding it to the syncer for propagation.
- {{ <sref block_producer "åŒºå—ç”Ÿäº§å™¨"> }} è¿™æ˜¯åœ¨ä¸€ä¸ªæˆåŠŸçš„é¢†å¯¼äººé€‰ä¸¾äº‹ä»¶ä¸­è°ƒç”¨ï¼Œä»¥äº§ç”Ÿä¸€ä¸ªæ–°çš„å—ï¼Œå®ƒå°†æ‰©å±•å½“å‰æœ€é‡çš„é“¾ï¼Œç„¶åè½¬å‘åˆ°åŒæ­¥å™¨è¿›è¡Œä¼ æ’­ã€‚
